<!DOCTYPE html>
<html>
<head>
<script src="js/jquery-latest.min.js" type="text/javascript"></script>
<script src="js/sigma.min.js" type="text/javascript"></script>
<script src="js/sigma.parseGexf.js" type="text/javascript"></script>

<script type="text/javascript">
<!--
function init() {
  var keyCodes = {
      ESCAPE: 27,
      H: 72,

      J: 74,
      K: 75,
      L: 76,


      ONE: 49,
      NINE: 57,
      ZERO: 48,
      PLUS: 61,
      MINUS: 109
  };
  var MIN_IMPORTANT_SIZE = 9;

  // Add overlay node.
  function addOverlayNode(node)
  {
    var o = $("<div>").addClass("overlay-node")
          .css("left", node["displayX"]).css("top", node["displayY"]).css("background-color", node.color);
    $("body").append(o);
    return o;
  }

  // Instanciate sigma.js and customize rendering :
  var sigInst = sigma.init(document.getElementById('graph-main')).drawingProperties({
    defaultLabelColor: '#fff',
    defaultLabelSize: 14,
    defaultLabelBGColor: '#fff',
    defaultLabelHoverColor: '#000',
    labelThreshold: 6,
    defaultEdgeType: 'curve',
    font: 'DejaVu Sans Mono, Arial'
  }).graphProperties({
    minNodeSize: 0.5,
    maxNodeSize: 5,
    minEdgeSize: 1,
    maxEdgeSize: 1
  }).mouseProperties({
    maxRatio: 32
  });

  sigInst.__proto__.zoomToNode = function(nid, zoom) {
    this.position(0,0,1);
    this.draw(2,2,2);
    var nodes = this.getNodes([nid]);
    var node = nodes[0];
    if (!node) return;
    zoom = zoom ? zoom : 16;
    switch (node.attr.node_type)
    {
        case "module":
            zoom = 10;
    }
    this.zoomTo(node.displayX, node.displayY, zoom);
  }

  sigInst.__proto__.pickNode = function(nid) {
    var s = this._core;
    this.iterNodes(function(node) {
      s.plotter.drawHoverNode(node);
    }, [nid]);
  }

  sigInst.__proto__.unpickNode = function(nid) {
    this.refresh();
  }

  sigInst.__proto__.getNodeById = function(nid) {
      var nodes = this.getNodes([nid]);
      return nodes[0];
  }

  sigInst.__proto__.function2moduleNode = function(functionNode) {
    var moduleNode;
    var fid = functionNode.id;
    var sig = this;
    this.iterEdges(function(e) {
        if ((e.attr.edge_type == "mf") && (e.source == fid))
        {
            // var s = sig.getNodeById(e.source);
            // s.type == "module"
            console.log("target " + e.target);
            moduleNode = sig.getNodeById(e.target);
        }
    });
    return moduleNode;
  }

  // elem is a DOM element.
  // node is a sigma node.
  function nodeToHtmlLink(si, node, elem)
  {
    var nid = node.id;
    var a = $("<a href='#'>").text(node.label);
    a.off(".show_node_label");
    a.on("click.show_node_label", function(e) {
      // Capture a Shift and Click event with jQuery
      if (e.shiftKey) {
        activateNode({'target': si, 'content': [nid]});
        return false;
      }
      si.zoomToNode(nid);
      return false;
    });
    a.on("mouseleave.show_node_label", function(){ 
        si.unpickNode(nid);
    });
    a.on("mouseenter.show_node_label", function(){ 
        si.pickNode(nid);
    });
    elem.append(a);
    return elem;
  }

  // Copy color from a node or an edge to DOM element.
  function colorize(nodeOrEdge, elem)
  {
    elem.css("color", nodeOrEdge.color)
    return elem;
  }

  var nodeIdsToHtml = function(si, nodes) {
    var ul = $("<ul>");
    si.iterNodes(function(node) {
      var elem = colorize(node, $("<li>"));
      var li = nodeToHtmlLink(si, node, elem);
      ul.append(li);
    }, nodes);
    return ul;
  }

  // This function will be called, if a node was clicked.
  var activateNode = function(event) { 
    var si = event.target; 
    var ids = event.content;
    var rcpnt_node_ids      = [];
    var donor_node_ids      = [];
    var module_node_ids     = [];
    var function_node_ids   = [];

    var node_id = ids[0];
    var node = si.getNodeById(node_id);

    $(".selected_elem_info").hide();
    var active_header_block;
    var focused_elem;

    // Change the header
    switch (node.attr.node_type)
    {
        case "module":
            var activeHeaderBlock = $("#selected_module_elem_info").show();
            var m_elem = $(".module_name", active_header_block).empty();
            nodeToHtmlLink(si, node, m_elem);
            var focused_elem = $("a", m_elem);
            break;

        // MFA
        default:
            var parent_node = si.function2moduleNode(node);
            $("#selected_function_elem_info").show();
            var fn_elem = $(".function_name", active_header_block).empty();
            var m_elem = $(".module_name", active_header_block).empty();
            nodeToHtmlLink(si, node, fn_elem);
            nodeToHtmlLink(si, parent_node, m_elem);
            var focused_elem = $("a", fn_elem);
    }

    si.iterEdges(function(e) {
        if ((ids.indexOf(e.source) != -1) && (e.attr.edge_type != "mf")) {
            // This edge is out.
            // The selected node calls the iterated node.
            donor_node_ids.push(e.target);
        }
        else if (ids.indexOf(e.target) != -1) {
            // This edge is in.
            // The selected node is called by the iterated node.
            rcpnt_node_ids.push(e.source);
        }
    });

    switch (node.attr.node_type)
    {
        case "module":
            function_node_ids = rcpnt_node_ids;
            rcpnt_node_ids = [];
    }
    

    if (donor_node_ids.length > 0)
    {
        var ul_out = nodeIdsToHtml(si, donor_node_ids);
        $("#directions-list-out").empty().append(ul_out);
        $("#directions-out").show();
    }
    else
    {
        $("#directions-out").hide();
    }

    if (rcpnt_node_ids.length > 0)
    {
        var ul_in  = nodeIdsToHtml(si, rcpnt_node_ids);
        $("#directions-list-in").empty().append(ul_in);
        $("#directions-in").show();
    }
    else
    {
        $("#directions-in").hide();
    }

    if (function_node_ids.length > 0)
    {
        var ul_in  = nodeIdsToHtml(si, function_node_ids);
        $("#functions-list").empty().append(ul_in);
        $("#functions").show();
    }
    else
    {
        $("#functions").hide();
    }
    openDirectionSidebar();

    // Set focus
    focused_elem.focus();
  }; // end of activateNode


  // Parse a GEXF encoded file to fill the graph
  // (requires "sigma.parseGexf.js" to be included)
  sigInst.parseGexf('data/v-e-m.gexf');

  // Draw the graph :
  sigInst.draw();

  // The node was clicked.
  sigInst.bind('downnodes', activateNode);




  var openDirectionSidebar = function() {
    $("body").addClass("directions-active"); 
  };

  var closeDirectionSidebar = function() {
    $("body").removeClass("directions-active"); 
  };

  var isDirectionSidebarOpen = function() {
    return $("body").hasClass("directions-active");
  };

  var resetScale = function(){ 
    sigInst.position(0, 0, 1);
    sigInst.draw(2, 2, 2);
    sigInst.goTo(0, 0, 1);
  };

  // Handler for closing the sidebar
  $("#graph-directions").click(function(e) {
      closeDirectionSidebar();
  });

  var repeatCount = 0;
  $(document).keydown(function(e) {
    var m = sigInst._core.mousecaptor;
    var s = sigInst._core;
    var kc = e.keyCode;
    switch (kc) {
      case keyCodes.ESCAPE:
        if (isDirectionSidebarOpen())
          closeDirectionSidebar();
        else
          resetScale();
        break;

      case keyCodes.ZERO:
        if (repeatCount == 0)
          resetScale();
        else
          repeatCount *= 10;
        break;

      case keyCodes.H:
        // right
        var step = s.width / 150;
        sigInst.goTo(step * (repeatCount || 1) + m.stageX, m.stageY);
        repeatCount = 0;
        break;

      case keyCodes.L:
        // left
        var step = s.width / 150;
        sigInst.goTo(-step * (repeatCount || 1) + m.stageX, m.stageY);
        repeatCount = 0;
        break;

      case keyCodes.K:
        // up
        var step = s.height / 100;
        sigInst.goTo(m.stageX, -step * (repeatCount || 1) + m.stageY);
        repeatCount = 0;
        break;

      case keyCodes.J:
        // down
        var step = s.height / 100;
        sigInst.goTo(m.stageX, step * (repeatCount || 1) + m.stageY);
        repeatCount = 0;
        break;

      case keyCodes.PLUS:
        var delta = 0.1 * (repeatCount || 1);
        sigInst.zoomTo(s.width / 2, s.height / 2, m.ratio + delta);
        repeatCount = 0;
        break;

      case keyCodes.MINUS:
        var delta = 0.1 * (repeatCount || 1);
        sigInst.zoomTo(s.width / 2, s.height / 2, m.ratio - delta);
        repeatCount = 0;
        break;

      default:

        if (kc >= keyCodes.ONE && kc <= keyCodes.NINE)
            repeatCount = repeatCount * 10 + kc - keyCodes.ZERO;
            
        console.log("Key pressed: " + e.keyCode);
    }
  });


  // The other canvas for a list of modules
  var modSigInst = sigma.init(document.getElementById('graph-modules')).drawingProperties({
    defaultLabelColor: '#fff',
    defaultLabelSize: 14,
    defaultLabelBGColor: '#fff',
    defaultLabelHoverColor: '#000',
    labelThreshold: 10,
    defaultEdgeType: 'curve'
  }).graphProperties({
    minNodeSize: 0.5,
    maxNodeSize: 5,
    minEdgeSize: 1,
    maxEdgeSize: 1
  }).mouseProperties({
    mouseEnabled: false
  });

  // Add border edges
  modSigInst.addNode(1, {
        'x': -1,
        'y': -2,
        'label' : "Left-Top",
        hidden: true,
        color: "#F00"
      });
  modSigInst.addNode(2, {
        'x': 40,
        'y': 25,
        'label' : "Right-Bottom",
        hidden: true,
        color: "#F00"
      });

  // All other nodes will have X and Y beetween -1 .. 1
  var nextModNodeId = 3;
  var firstModNodeId = 3;

  // Add large nodes (modules).
  sigInst.iterNodes(function(node) {
    if (node.size < MIN_IMPORTANT_SIZE)
      return; // too small

    var countX = 10;
    var countY = 20;
    var num = nextModNodeId - firstModNodeId;
    var numX = parseInt(num / countY); // 0 .. 10
    var numY = num % countY;           // 0 .. 10
    modSigInst.addNode(nextModNodeId,{
      'x':  numX,
      'y': numY,
      'size': node.size,
      'hidden': true,
      'label': node.label,
      'realNodeId': node.id,
      'color': node.color
    });
    nextModNodeId++;
  });

  // Hide module-function edges.
  sigInst.iterEdges(function(edge) {
    if (edge.attr.edge_type == "mf") edge.hidden = true;
  });

   modSigInst.draw();

  // By default, the events on the main node are not passed down.
  // Add for all nodes on modules' canvas a special block above the main canvas.
  modSigInst.iterNodes(function(node) {
    var nid = node.id;
    var realNid = node.attr["realNodeId"];
    // Skip border nodes
    if (nid < firstModNodeId)
      return;
    var o = addOverlayNode(node);
    o.mouseenter(function(){ 
        $("body").addClass("active-hover-modules");
        modSigInst.pickNode(nid); 
        sigInst.pickNode(realNid); 
    });
    o.mouseleave(function(){ 
        $("body").removeClass("active-hover-modules");
        modSigInst.unpickNode(nid); 
        sigInst.unpickNode(realNid); 
    });

    o.click(function() {
        sigInst.zoomToNode(realNid, 5);
    });
  });

  // Add a handler for "Modules" label.
  $("#graph-modules-link a").click(function(e) { 
    $("body").toggleClass("active-modules");
  });

  $("#graph-main canvas").each(function() {
    this.addEventListener('dblclick', resetScale);
  });


  $(".header-closed").click(function(e) { 
      var t = $(e.target);
      var p = t.parent().addClass("active-block"); 
      $("a:visible:first", p).focus();
      return false;
  });

  $(".header-open").click(function(e) { 
      var t = $(e.target);
      var p = t.parent().removeClass("active-block"); 
      $("a:visible:first", p).focus();
      return false;
  });
}
$(document).ready(init);
-->
</script>

<style type="text/css">
<!--
  @font-face {
    font-family: 'DejaVu Sans Mono';
    font-style: normal;
    font-weight: 400;
    src: local('DejaVu Sans Mono'), url(font/DejaVuSansMono.woff) format('woff');
  }

  body {
    font-family: DejaVu Sans Mono, Arial;
    font-size: 13pt;
    overflow: hidden;
  }

  /* sigma.js context : */
  #container {
    background: #000;
    height: 100%;
    overflow: hidden;
  }
  #graph-main {
    width: 100%;
    height: 100%;
    z-index: 2000;
  }
  #graph-directions { 
    background: #000;
    width: 300px; 
    top: 0px; 
    bottom: 0px;
    position: absolute;
    z-index: 9000;
    right: 0px;
    color: #FFF;
    overflow: auto;
    display: none;
  }
  .directions-active #graph-directions { 
    display: block;
  }
  #graph-directions a, #graph-modules-link a { 
      text-decoration: none;
      color: inherit;
  }
  #graph-directions a.header-closed,
  #graph-modules-link a.header-closed {
    color: #C0C0C0;
  }
  #graph-directions a.header-open, 
  #graph-modules-link a.header-open {
    color: #FFF;
  }
  #graph-modules { 
    width: 500px; 
    height: 340px; 
    position: absolute;
    z-index: -1;
  }
  #graph-modules-link { 
    margin-left: 2px;
    margin-top: 2px;
    position: absolute;
    z-index: 9001;
    color: white;
  }
  html, body
  {margin: 0; padding: 0; height: 100%;}
  .disable_mouse_selection {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    cursor: default;
  }
  .overlay-node {
    position: absolute;
    width: 10px;
    height: 10px;
    margin-left: -5px;
    margin-top: -5px;
    z-index: -1;
    -moz-border-radius: 5px;
    border-radius: 5px;
  }
  .active-modules .overlay-node {
    z-index: 9050;
  }
  .active-hover-modules .overlay-node:hover {
    z-index: 9500;
  }
  .active-hover-modules #graph-modules { 
    z-index: 9200;
  }

  .selected_elem_info {
      font-size: 14pt;
      text-align: right;
      padding: 6px;
  }
  .misc {
      font-size: 80%;
      /* For new line */
      display: block;
  }
  #graph-directions ul {
    margin: 0px;
    padding: 0px;
    margin-left: 14pt;
  }
  #graph-directions > div {
    padding: 10px;
  }

  .active-block .header-closed {
    display: none;
  }
  .header-closed {
    display: block;
  }

  .active-block .header-open {
    display: block;
  }
  .header-open {
    display: none;
  }

  .active-block .block-content {
    display: block;
  }
   .block-content {
    display: none;
  }

-->
</style>

</head>
<body>
  <div id="container">
    <div id="graph-modules-link" class="disable_mouse_selection">
      <a href="#" class="header-closed">Modules...</a>
      <a href="#" class="header-open">Modules:</a>
    </div>
    <div id="graph-modules"></div>
    <div id="graph-main"></div>
    <div id="graph-directions">
        <div id="selected_function_elem_info" class="selected_elem_info">
            Function <span class="function_name">FunctionName</span> 
            <span class="misc">from 
                <span class="module_name">ModuleName</span>
            </span>
        </div>

        <div id="selected_module_elem_info" class="selected_elem_info">
            Module <span class="module_name">ModuleName</span>
        </div>

        <!--
        <div id="modules">
            Modules:
            <div id="modules-list"></div>
        </div>
        -->

        <div id="functions" class="active-block">
            <a href="#" class="header-closed">Functions...</a>
            <a href="#" class="header-open">Functions:</a>
            <div id="functions-list" class="block-content"></div>
        </div>

        <div id="directions-out" class="active-block">
            <a href="#" class="header-closed">Calls...</a>
            <a href="#" class="header-open">Calls:</a>
            <div id="directions-list-out" class="block-content"></div>
        </div>

        <div id="directions-in" class="active-block">
            <a href="#" class="header-closed">Called by...</a>
            <a href="#" class="header-open">Called by:</a>
            <div id="directions-list-in" class="block-content"></div>
        </div>
    </div>
  </div>
</body>
</html>
